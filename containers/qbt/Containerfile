###############################
# Stage 1 — Build environment #
###############################
FROM debian:stable AS builder

ENV DEBIAN_FRONTEND=noninteractive

# Base tools
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    pkg-config \
    git \
    tree \
    nano \
    ca-certificates \
    python3 \
    zlib1g-dev \
    libssl-dev \
    libboost-all-dev \
    qt6-base-dev \
    qt6-base-private-dev \
    qt6-tools-dev \
    qt6-tools-private-dev \
    qt6-svg-dev \
    qttools5-dev-tools \
    libqt5xmlpatterns5-dev && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /tmp

###############################
# Build libtorrent 2.0.11     #
###############################
ARG LIBTORRENT_VERSION=2.0.11

RUN git -c advice.detachedHead=false clone --branch v${LIBTORRENT_VERSION} https://github.com/arvidn/libtorrent.git && \
    cd libtorrent && \
    git submodule update --init --recursive && \
    cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local && \
    cmake --build build -j$(nproc) && \
    cmake --install build

###############################
# Build qBittorrent 5.0.3     #
###############################
ARG QBITTORRENT_VERSION=5.0.3

RUN git -c advice.detachedHead=false clone --branch release-${QBITTORRENT_VERSION} --depth=1 https://github.com/qbittorrent/qBittorrent.git && \
    cd qBittorrent && \
    cmake -B build \
    -DCMAKE_BUILD_TYPE=Release \
    -DGUI=OFF \
    -DCMAKE_INSTALL_PREFIX=/usr/local && \
    cmake --build build -j$(nproc) && \
    cmake --install build

################################
# Stage 2 — Runtime environment #
################################
FROM debian:stable

ENV DEBIAN_FRONTEND=noninteractive

# Runtime dependencies only
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    tree \
    nano \
    libssl3 \
    zlib1g \
    libboost-system1.83.0 \
    libboost-chrono1.83.0 \
    libboost-random1.83.0 \
    libboost-serialization1.83.0 \
    qt6-base-dev-tools \
    libqt6core6 \
    libqt6network6 \
    libqt6xml6 \
    libqt6sql6 \
    libqt6sql6-sqlite \
    libqt6concurrent6 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Copy artifacts from builder
COPY --from=builder /usr/local /usr/local

# Ensure dynamic linker can find libtorrent
RUN echo "/usr/local/lib" > /etc/ld.so.conf.d/usr-local-lib.conf && \
    ldconfig

# Create runtime directories
RUN mkdir -p /config /downloads && \
    useradd -m qbittorrent && \
    chown -R qbittorrent:qbittorrent /config /downloads

# Use the default UID=1000; GID=1000 username: qbittorrent
USER qbittorrent

EXPOSE 1340/tcp

ENTRYPOINT ["/usr/local/bin/qbittorrent-nox", "--profile=/config", "--webui-port=1340"]
